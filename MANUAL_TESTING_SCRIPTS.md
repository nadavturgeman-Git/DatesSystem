# 📋 תסריטי בדיקות ידניות - מערכת ניהול חוות תמרים

**תאריך**: 2026-01-19  
**גרסה**: 1.0  
**מצב**: מוכן לבדיקה ✅

---

## 🎯 סקירה כללית

מסמך זה מכיל תסריטי בדיקות ידניות מפורטים לכל הזרימות העיקריות במערכת. כל תסריט כולל:
- ✅ מטרת הבדיקה
- 📝 שלבים מפורטים
- ✅ תוצאות צפויות
- 🔍 אימות במסד הנתונים (אופציונלי)

---

## 📚 תוכן עניינים

1. [בדיקות אימות והרשמה](#1-בדיקות-אימות-והרשמה)
2. [בדיקות דשבורד](#2-בדיקות-דשבורד)
3. [בדיקות הזמנות ציבוריות](#3-בדיקות-הזמנות-ציבוריות)
4. [בדיקות תהליך תשלום](#4-בדיקות-תהליך-תשלום)
5. [בדיקות ניהול הזמנות (מפיץ)](#5-בדיקות-ניהול-הזמנות-מפיץ)
6. [בדיקות ניהול הזמנות (אדמין)](#6-בדיקות-ניהול-הזמנות-אדמין)
7. [בדיקות FIFO ואישור טעינה](#7-בדיקות-fifo-ואישור-טעינה)
8. [בדיקות עמלות](#8-בדיקות-עמלות)
9. [בדיקות CRM לקוחות](#9-בדיקות-crm-לקוחות)
10. [בדיקות הרשאות](#10-בדיקות-הרשאות)

---

## 1. בדיקות אימות והרשמה

### 1.1 הרשמה כמפיץ חדש

**מטרה**: לוודא שהרשמה יוצרת פרופיל מפיץ עם מודל התחשבנות

**שלבים**:
1. פתח `http://localhost:3000/signup`
2. מלא את הטופס:
   - שם מלא: "מפיץ בדיקה"
   - אימייל: `test-distributor-{timestamp}@example.com`
   - טלפון: `050-1234567`
   - סיסמה: `Test1234!`
   - אימות סיסמה: `Test1234!`
   - **מודל התחשבנות**: בחר אחד מהבאים:
     - תלוש משכורת (עובד שכיר)
     - עסק פרטי (עוסק מורשה / חברה)
     - מזומן / Paybox
     - עמלה בסחורה
3. לחץ על "הירשם"

**תוצאות צפויות**:
- ✅ הטופס נשלח בהצלחה
- ✅ מועבר לדשבורד (`/dashboard`)
- ✅ הודעת הצלחה מוצגת (אם יש)
- ✅ אין שגיאות בקונסול

**אימות במסד נתונים**:
```sql
SELECT 
  p.email,
  p.full_name,
  p.role,
  dp.employment_model,
  dp.preferred_payment_method
FROM profiles p
LEFT JOIN distributor_profiles dp ON p.id = dp.user_id
WHERE p.email = 'test-distributor-{timestamp}@example.com';
```

**צפוי לראות**:
- `role` = 'distributor'
- `employment_model` = הערך שבחרת
- `preferred_payment_method` = בהתאם למודל

---

### 1.2 התחברות

**מטרה**: לוודא שהתחברות עובדת לכל סוגי המשתמשים

**שלבים**:
1. פתח `http://localhost:3000/login`
2. הזן אימייל וסיסמה של משתמש קיים
3. לחץ על "התחבר"

**תוצאות צפויות**:
- ✅ מועבר לדשבורד
- ✅ שם המשתמש מוצג בדשבורד
- ✅ תפקיד המשתמש מוצג נכון

**בדיקות לפי תפקיד**:
- **מפיץ**: רואה קישור הזמנה ציבורי
- **אדמין**: רואה תפריט ניהול
- **ראש צוות**: רואה תפריט צוות

---

### 1.3 התחברות עם Google OAuth

**מטרה**: לוודא שהתחברות עם Google עובדת

**שלבים**:
1. פתח `http://localhost:3000/login`
2. לחץ על "התחבר עם Google"
3. בחר חשבון Google
4. אשר הרשאות

**תוצאות צפויות**:
- ✅ מועבר חזרה לאפליקציה
- ✅ פרופיל נוצר אוטומטית
- ✅ מועבר לדשבורד

---

## 2. בדיקות דשבורד

### 2.1 דשבורד מפיץ

**מטרה**: לוודא שהדשבורד מציג מידע נכון למפיץ

**שלבים**:
1. התחבר כמפיץ
2. פתח `http://localhost:3000/dashboard`

**תוצאות צפויות**:
- ✅ **קישור הזמנה ציבורי**:
  - קישור מוצג בבלוק ירוק
  - כפתור "העתק קישור" עובד
  - כפתורי שיתוף (ווטסאפ, שתף) עובדים
- ✅ **סטטיסטיקות**:
  - מלאי כולל (ק"ג)
  - מחסנים פעילים
  - מוצרים
- ✅ **רשימת מחסנים**: מציגה מחסנים פעילים
- ✅ **רשימת מוצרים**: מציגה מוצרים פעילים

**בדיקות נוספות**:
- [ ] הקישור הציבורי עובד (פתח אותו בדפדפן אחר)
- [ ] העתקת קישור עובדת
- [ ] שיתוף בווטסאפ עובד

---

### 2.2 דשבורד אדמין

**מטרה**: לוודא שהדשבורד מציג מידע נכון לאדמין

**שלבים**:
1. התחבר כאדמין
2. פתח `http://localhost:3000/dashboard`

**תוצאות צפויות**:
- ✅ אין קישור הזמנה ציבורי (רק למפיצים)
- ✅ סטטיסטיקות מוצגות
- ✅ תפריט ניהול זמין

---

## 3. בדיקות הזמנות ציבוריות

### 3.1 יצירת הזמנה חדשה (לקוח חדש)

**מטרה**: לוודא שלקוח חדש יכול ליצור הזמנה

**שלבים**:
1. פתח קישור הזמנה ציבורי: `http://localhost:3000/order/{DISTRIBUTOR_ID}`
2. הוסף מוצרים לעגלה:
   - לחץ על כפתור "+" ליד מוצר
   - שנה כמות (אם אפשר)
   - הוסף עוד מוצרים
3. לחץ על "עגלה" או "הזמן עכשיו"
4. בטופס ההזמנה:
   - שם: "לקוח בדיקה"
   - טלפון: `052-9876543` (מספר חדש)
   - אימייל: `customer-test@example.com`
   - כתובת: "רחוב בדיקה 1, תל אביב"
   - **אמצעי תשלום**: בחר אחד (כרטיס אשראי, Bit, Paybox, מזומן)
5. לחץ על "שלח הזמנה"

**תוצאות צפויות**:
- ✅ הודעת הצלחה מוצגת
- ✅ מספר הזמנה מוצג
- ✅ ההזמנה נרשמת במערכת
- ✅ לקוח חדש נוצר במסד הנתונים

**אימות במסד נתונים**:
```sql
-- בדוק שההזמנה נוצרה
SELECT 
  order_number,
  status,
  payment_status,
  total_weight_kg,
  total_amount,
  customer_id
FROM orders
WHERE created_at > NOW() - INTERVAL '10 minutes'
ORDER BY created_at DESC
LIMIT 1;

-- בדוק שהלקוח נוצר
SELECT 
  full_name,
  phone,
  total_orders,
  lifetime_value
FROM customers
WHERE phone = '0529876543'
LIMIT 1;
```

---

### 3.2 יצירת הזמנה (לקוח חוזר)

**מטרה**: לוודא שהמערכת מזהה לקוח חוזר וממלאת פרטים אוטומטית

**שלבים**:
1. פתח קישור הזמנה ציבורי
2. הוסף מוצרים לעגלה
3. פתח טופס הזמנה
4. הזן טלפון של לקוח קיים: `052-9876543`
5. לחץ מחוץ לשדה הטלפון (או Tab)

**תוצאות צפויות**:
- ✅ ספינר טעינה מוצג לרגע
- ✅ תג ירוק מוצג: "לקוח חוזר - הפרטים הושלמו אוטומטית"
- ✅ שם מלא מתמלא אוטומטית
- ✅ אימייל מתמלא אוטומטית (אם היה)
- ✅ ניתן לערוך את הפרטים

**אימות**:
- [ ] הפרטים מתמלאים נכון
- [ ] ניתן לערוך את הפרטים
- [ ] ההזמנה מקושרת ללקוח הקיים

---

### 3.3 עגלת קניות

**מטרה**: לוודא שעגלת הקניות עובדת נכון

**שלבים**:
1. פתח קישור הזמנה ציבורי
2. הוסף מוצרים שונים לעגלה
3. פתח את העגלה (לחץ על "עגלה" או אייקון)

**תוצאות צפויות**:
- ✅ כל המוצרים שהוספת מוצגים
- ✅ כמות נכונה לכל מוצר
- ✅ מחיר כולל נכון
- ✅ ניתן לשנות כמות
- ✅ ניתן להסיר מוצרים
- ✅ סה"כ משקל נכון
- ✅ סה"כ מחיר נכון

**בדיקות נוספות**:
- [ ] שינוי כמות מעדכן את הסה"כ
- [ ] הסרת מוצר מעדכנת את הסה"כ
- [ ] עגלה ריקה מציגה הודעה מתאימה

---

## 4. בדיקות תהליך תשלום

### 4.1 תשלום מזומן

**מטרה**: לוודא שהזמנה עם תשלום מזומן נוצרת נכון

**שלבים**:
1. צור הזמנה חדשה
2. בחר "מזומן" כאמצעי תשלום
3. שלח את ההזמנה

**תוצאות צפויות**:
- ✅ ההזמנה נוצרת עם `payment_status = 'pending'`
- ✅ `payment_method = 'cash'`
- ✅ המפיץ רואה את ההזמנה בדשבורד
- ✅ המפיץ יכול לסמן את ההזמנה כשולמה

**אימות**:
```sql
SELECT 
  order_number,
  payment_method,
  payment_status,
  status
FROM orders
WHERE order_number = '{ORDER_NUMBER}';
```

---

### 4.2 תשלום Paybox (מפיץ עם Cash_Paybox)

**מטרה**: לוודא שמפיץ עם מודל Cash_Paybox רואה קישור Paybox

**שלבים**:
1. ודא שיש מפיץ עם `employment_model = 'Cash_Paybox'` ו-`paybox_link` מוגדר
2. התחבר כמפיץ זה
3. צור הזמנה דרך הקישור הציבורי
4. בחר "Paybox" כאמצעי תשלום
5. שלח את ההזמנה

**תוצאות צפויות**:
- ✅ ההזמנה נוצרת
- ✅ אם יש קישור Paybox, הוא מוצג בדף התשלום
- ✅ הלקוח יכול ללחוץ על הקישור

---

### 4.3 סימון תשלום (מפיץ)

**מטרה**: לוודא שמפיץ יכול לסמן הזמנה כשולמה

**שלבים**:
1. התחבר כמפיץ
2. פתח את דף ההזמנות: `http://localhost:3000/orders`
3. מצא הזמנה עם `payment_status = 'pending'`
4. לחץ על "סמן כשולם" או כפתור דומה

**תוצאות צפויות**:
- ✅ ההזמנה מתעדכנת ל-`payment_status = 'paid'`
- ✅ `paid_at` מתעדכן
- ✅ ההזמנה מוכנה לאישור טעינה

**אימות**:
```sql
SELECT 
  order_number,
  payment_status,
  paid_at
FROM orders
WHERE order_number = '{ORDER_NUMBER}';
```

---

## 5. בדיקות ניהול הזמנות (מפיץ)

### 5.1 צפייה בהזמנות שלי

**מטרה**: לוודא שמפיץ רואה רק את ההזמנות שלו

**שלבים**:
1. התחבר כמפיץ
2. פתח `http://localhost:3000/orders`

**תוצאות צפויות**:
- ✅ רק הזמנות של המפיץ מוצגות
- ✅ כל ההזמנות מוצגות (לא רק של מפיץ אחר)
- ✅ ניתן לראות:
  - מספר הזמנה
  - תאריך
  - סטטוס
  - סטטוס תשלום
  - משקל כולל
  - סכום כולל

---

### 5.2 פרטי הזמנה

**מטרה**: לוודא שפרטי הזמנה מוצגים נכון

**שלבים**:
1. פתח דף הזמנות
2. לחץ על הזמנה מסוימת

**תוצאות צפויות**:
- ✅ פרטי ההזמנה מוצגים:
  - מספר הזמנה
  - תאריך יצירה
  - לקוח (אם יש)
  - מוצרים וכמויות
  - סה"כ משקל
  - סה"כ מחיר
  - סטטוס
  - סטטוס תשלום

---

## 6. בדיקות ניהול הזמנות (אדמין)

### 6.1 צפייה בכל ההזמנות

**מטרה**: לוודא שאדמין רואה את כל ההזמנות

**שלבים**:
1. התחבר כאדמין
2. פתח `http://localhost:3000/admin/orders` (או דף הזמנות)

**תוצאות צפויות**:
- ✅ כל ההזמנות מוצגות (של כל המפיצים)
- ✅ ניתן לסנן לפי:
  - מפיץ
  - סטטוס
  - תאריך
- ✅ ניתן לראות פרטים מלאים

---

### 6.2 אישור טעינה (Loading Approval)

**מטרה**: לוודא שאדמין יכול לאשר טעינה והמלאי הפיזי מתעדכן

**שלבים**:
1. ודא שיש הזמנה עם:
   - `payment_status = 'paid'`
   - `loading_approved_at IS NULL`
2. התחבר כאדמין
3. פתח את דף ההזמנות או דף אישור טעינה
4. מצא את ההזמנה
5. לחץ על "אשר טעינה" או כפתור דומה

**תוצאות צפויות**:
- ✅ ההזמנה מתעדכנת:
  - `loading_approved_at` מתעדכן
  - `loading_approved_by` = ID של האדמין
  - `status` = 'packed'
  - `delivery_status` = 'In_Transit'
- ✅ **המלאי הפיזי מתעדכן**:
  - משקלי המשטחים (`current_weight_kg`) יורדים
  - `pallet_allocations` נוצרים
  - `stock_reservations` הופכים ל-`is_active = FALSE`

**אימות קריטי**:
```sql
-- בדוק שהמלאי הפיזי ירד
SELECT 
  p.pallet_id,
  p.current_weight_kg,
  p.initial_weight_kg,
  p.is_depleted
FROM pallets p
JOIN pallet_allocations pa ON p.id = pa.pallet_id
JOIN order_items oi ON pa.order_item_id = oi.id
JOIN orders o ON oi.order_id = o.id
WHERE o.order_number = '{ORDER_NUMBER}';

-- בדוק שההזמנות המלאי הוסרו
SELECT 
  sr.is_active,
  sr.released_at
FROM stock_reservations sr
JOIN orders o ON sr.order_id = o.id
WHERE o.order_number = '{ORDER_NUMBER}';
```

---

## 7. בדיקות FIFO ואישור טעינה

### 7.1 בדיקת FIFO - בחירת המשטחים הישנים ביותר

**מטרה**: לוודא שהמערכת בוחרת משטחים לפי FIFO (First In First Out)

**שלבים**:
1. ודא שיש משטחים עם תאריכי כניסה שונים:
   ```sql
   -- צור משטחים לבדיקה
   INSERT INTO pallets (pallet_id, warehouse_id, product_id, entry_date, initial_weight_kg, current_weight_kg)
   VALUES 
     ('TEST-FIFO-001', '{WAREHOUSE_ID}', '{PRODUCT_ID}', '2026-01-01', 500, 500),
     ('TEST-FIFO-002', '{WAREHOUSE_ID}', '{PRODUCT_ID}', '2026-01-05', 500, 500),
     ('TEST-FIFO-003', '{WAREHOUSE_ID}', '{PRODUCT_ID}', '2026-01-10', 500, 500);
   ```
2. צור הזמנה של 750 ק"ג (1.5 משטחים)
3. סמן את ההזמנה כשולמה
4. אשר טעינה כאדמין

**תוצאות צפויות**:
- ✅ המשטחים שנבחרו הם:
  - `TEST-FIFO-001` (הישן ביותר - 1 בינואר)
  - `TEST-FIFO-002` (הבא בתור - 5 בינואר)
- ✅ המשקל המוקצה:
  - `TEST-FIFO-001`: 500 ק"ג
  - `TEST-FIFO-002`: 250 ק"ג

**אימות**:
```sql
SELECT 
  p.pallet_id,
  p.entry_date,
  pa.allocated_weight_kg
FROM pallet_allocations pa
JOIN pallets p ON pa.pallet_id = p.id
JOIN order_items oi ON pa.order_item_id = oi.id
JOIN orders o ON oi.order_id = o.id
WHERE o.order_number = '{ORDER_NUMBER}'
ORDER BY p.entry_date ASC;
```

---

### 7.2 בדיקת Virtual Lock - מלאי זמין יורד אבל פיזי לא

**מטרה**: לוודא שהמלאי הזמין יורד מיד אבל המלאי הפיזי נשאר עד אישור טעינה

**שלבים**:
1. בדוק את המלאי הזמין לפני:
   ```sql
   SELECT get_available_stock('{PRODUCT_ID}');
   ```
2. צור הזמנה חדשה
3. בדוק את המלאי הזמין אחרי:
   ```sql
   SELECT get_available_stock('{PRODUCT_ID}');
   ```
4. בדוק את המלאי הפיזי:
   ```sql
   SELECT SUM(current_weight_kg) FROM pallets WHERE product_id = '{PRODUCT_ID}' AND is_depleted = FALSE;
   ```

**תוצאות צפויות**:
- ✅ המלאי הזמין ירד (מינוס המשקל שהוזמן)
- ✅ המלאי הפיזי נשאר ללא שינוי
- ✅ `stock_reservations` נוצרו עם `is_active = TRUE`

**אימות**:
```sql
-- בדוק הזמנות מלאי פעילות
SELECT 
  sr.reserved_weight_kg,
  sr.expires_at,
  sr.is_active
FROM stock_reservations sr
JOIN orders o ON sr.order_id = o.id
WHERE o.order_number = '{ORDER_NUMBER}';
```

---

## 8. בדיקות עמלות

### 8.1 חישוב עמלה לפי טיירים

**מטרה**: לוודא שהעמלה מחושבת נכון לפי סה"כ משקל במחזור

**שלבים**:
1. צור מחזור מכירות (sales_cycle)
2. צור 3 הזמנות של אותו מפיץ באותו מחזור:
   - הזמנה 1: 20 ק"ג
   - הזמנה 2: 20 ק"ג
   - הזמנה 3: 20 ק"ג
   - **סה"כ: 60 ק"ג** → צריך להיות 17% (לא 15% לכל הזמנה)
3. בדוק את העמלה

**תוצאות צפויות**:
- ✅ העמלה מחושבת על בסיס סה"כ 60 ק"ג
- ✅ שיעור עמלה: 17% (לא 15%)
- ✅ העמלה מחושבת נכון

**אימות**:
```sql
SELECT 
  commission_rate,
  commission_amount,
  base_amount
FROM commissions
WHERE user_id = '{DISTRIBUTOR_ID}'
AND created_at > '{CYCLE_START_DATE}'
ORDER BY created_at DESC;
```

---

### 8.2 עמלת ראש צוות

**מטרה**: לוודא שראש צוות מקבל 5% מסך המכירות של האזור

**שלבים**:
1. ודא שיש מפיץ עם `team_leader_id` מוגדר
2. צור הזמנות של המפיץ
3. בדוק את העמלה של ראש הצוות

**תוצאות צפויות**:
- ✅ עמלה נוצרת לראש הצוות
- ✅ שיעור עמלה: 5%
- ✅ בסיס חישוב: סך המכירות של המפיצים תחתיו

---

## 9. בדיקות CRM לקוחות

### 9.1 עדכון סטטיסטיקות לקוח

**מטרה**: לוודא שסטטיסטיקות הלקוח מתעדכנות אוטומטית

**שלבים**:
1. צור הזמנה של לקוח קיים
2. בדוק את הסטטיסטיקות לפני ואחרי

**תוצאות צפויות**:
- ✅ `total_orders` עולה ב-1
- ✅ `lifetime_value` מתעדכן עם הסכום החדש
- ✅ `last_order_date` מתעדכן לתאריך הנוכחי

**אימות**:
```sql
SELECT 
  full_name,
  total_orders,
  lifetime_value,
  last_order_date
FROM customers
WHERE phone = '{CUSTOMER_PHONE}';
```

---

### 9.2 חיפוש לקוח

**מטרה**: לוודא שניתן לחפש לקוח לפי טלפון

**שלבים**:
1. פתח דף הזמנה ציבורית
2. הזן טלפון של לקוח קיים
3. לחץ מחוץ לשדה

**תוצאות צפויות**:
- ✅ הלקוח נמצא
- ✅ הפרטים מתמלאים אוטומטית
- ✅ תג "לקוח חוזר" מוצג

---

## 10. בדיקות הרשאות

### 10.1 הרשאות מפיץ

**מטרה**: לוודא שמפיץ רואה רק את הנתונים שלו

**בדיקות**:
- [ ] מפיץ רואה רק את ההזמנות שלו
- [ ] מפיץ לא רואה הזמנות של מפיצים אחרים
- [ ] מפיץ לא יכול לגשת לדפי אדמין
- [ ] מפיץ יכול לסמן הזמנות כשולמו

---

### 10.2 הרשאות אדמין

**מטרה**: לוודא שאדמין יכול לעשות הכל

**בדיקות**:
- [ ] אדמין רואה את כל ההזמנות
- [ ] אדמין יכול לאשר טעינה
- [ ] אדמין יכול לראות את כל המשתמשים
- [ ] אדמין יכול לנהל מוצרים ומחסנים

---

### 10.3 הרשאות ראש צוות

**מטרה**: לוודא שראש צוות יכול לנהל החזרות

**שלבים**:
1. התחבר כראש צוות
2. פתח `http://localhost:3000/admin/returns` (או דף החזרות)

**תוצאות צפויות**:
- ✅ ראש צוות יכול לראות החזרות
- ✅ ראש צוות יכול לאשר החזרות
- ✅ אין שגיאת הרשאה

---

## 📊 טבלת מעקב בדיקות

השתמש בטבלה הזו כדי לעקוב אחרי הבדיקות שביצעת:

| # | בדיקה | סטטוס | תאריך | הערות |
|---|--------|--------|--------|--------|
| 1.1 | הרשמה כמפיץ חדש | ⬜ | | |
| 1.2 | התחברות | ⬜ | | |
| 1.3 | התחברות Google | ⬜ | | |
| 2.1 | דשבורד מפיץ | ⬜ | | |
| 2.2 | דשבורד אדמין | ⬜ | | |
| 3.1 | הזמנה חדשה (לקוח חדש) | ⬜ | | |
| 3.2 | הזמנה חדשה (לקוח חוזר) | ⬜ | | |
| 3.3 | עגלת קניות | ⬜ | | |
| 4.1 | תשלום מזומן | ⬜ | | |
| 4.2 | תשלום Paybox | ⬜ | | |
| 4.3 | סימון תשלום | ⬜ | | |
| 5.1 | צפייה בהזמנות (מפיץ) | ⬜ | | |
| 5.2 | פרטי הזמנה | ⬜ | | |
| 6.1 | צפייה בכל ההזמנות (אדמין) | ⬜ | | |
| 6.2 | אישור טעינה | ⬜ | | |
| 7.1 | בדיקת FIFO | ⬜ | | |
| 7.2 | בדיקת Virtual Lock | ⬜ | | |
| 8.1 | חישוב עמלה לפי טיירים | ⬜ | | |
| 8.2 | עמלת ראש צוות | ⬜ | | |
| 9.1 | עדכון סטטיסטיקות לקוח | ⬜ | | |
| 9.2 | חיפוש לקוח | ⬜ | | |
| 10.1 | הרשאות מפיץ | ⬜ | | |
| 10.2 | הרשאות אדמין | ⬜ | | |
| 10.3 | הרשאות ראש צוות | ⬜ | | |

---

## 🐛 דיווח על באגים

אם מצאת באג, מלא את הטופס הבא:

**תיאור הבאג**:
- מה קרה?
- מה ציפית שיקרה?
- מה קרה בפועל?

**שלבים לשחזור**:
1. ...
2. ...
3. ...

**סביבה**:
- דפדפן: ...
- מערכת הפעלה: ...
- גרסה: ...

**צילומי מסך**: (אם רלוונטי)

**לוגים**:
```
[הדבק לוגים מהקונסול]
```

---

## ✅ סיכום

לאחר שתסיים את כל הבדיקות:

1. סמן את הטבלה למעלה
2. צור דוח סיכום
3. דווח על באגים שנמצאו
4. אשר שהכל עובד לפני פרודקשן

**בהצלחה!** 🚀
